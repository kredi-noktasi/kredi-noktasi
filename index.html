<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Kredi Karar Sistemi Pro 2026</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js "></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js "></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js ';
</script>
<style>
:root{
  --bg:#0a0e1a;--card:#111827;--text:#f3f4f6;--muted:#9ca3af;
  --success:#10b981;--warning:#f59e0b;--danger:#ef4444;--accent:#3b82f6;--info:#06b6d4;
  --purple:#8b5cf6;--orange:#f97316;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,sans-serif;min-height:100vh}
.container{max-width:1400px;margin:0 auto;padding:20px}
.card{
  background:var(--card);border:1px solid rgba(255,255,255,0.1);
  border-radius:16px;padding:24px;margin-bottom:20px;
}
h1{font-size:24px;margin:0 0 8px 0}
h2{font-size:18px;margin:0 0 16px 0;color:var(--muted)}
h3{font-size:16px;margin:0 0 12px 0}

.form-grid{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;
}
.form-group label{
  display:block;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;
  color:var(--muted);margin-bottom:6px;font-weight:600;
}
.form-group input,.form-group select, .file-input{
  width:100%;padding:12px;background:#1f2937;border:1px solid rgba(255,255,255,0.1);
  border-radius:8px;color:var(--text);font-size:14px;
}
.form-group input:focus,.form-group select:focus{outline:none;border-color:var(--accent)}
.file-input{cursor:pointer;padding:20px;text-align:center;border-style:dashed}
.file-input:hover{background:rgba(59,130,246,0.1)}

/* TC Maskeli gÃ¶sterim iÃ§in stil */
.tc-masked {
  font-family: monospace;
  letter-spacing: 1px;
}

.btn{
  padding:10px 20px;border-radius:8px;border:none;font-weight:600;cursor:pointer;
  transition:all 0.2s;font-size:13px;display:inline-flex;align-items:center;gap:6px;
}
.btn-primary{background:var(--accent);color:white}
.btn-secondary{background:rgba(255,255,255,0.1);color:var(--text)}
.btn-danger{background:var(--danger);color:white}
.btn-success{background:var(--success);color:black}
.btn-warning{background:var(--warning);color:black}
.btn-purple{background:var(--purple);color:white}
.btn-orange{background:var(--orange);color:white}
.btn:hover:not(:disabled){transform:translateY(-1px);opacity:0.9}
.btn:disabled{opacity:0.5;cursor:not-allowed}

.top-actions{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap;justify-content:space-between;align-items:center}

.tabs{display:flex;gap:4px;margin-bottom:20px;border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:12px}
.tab-btn{
  padding:10px 20px;border-radius:8px;background:transparent;border:none;
  color:var(--muted);font-weight:600;cursor:pointer;transition:all 0.2s;
}
.tab-btn.active{background:rgba(59,130,246,0.2);color:var(--accent)}
.tab-btn:hover:not(.active){background:rgba(255,255,255,0.05);color:var(--text)}

/* PDF Rapor detay kartlarÄ± */
.pdf-detail-card{
  background:rgba(0,0,0,0.3);
  border:1px solid rgba(255,255,255,0.1);
  border-radius:12px;
  padding:16px;
  margin-bottom:16px;
}
.pdf-detail-card h4{
  margin:0 0 12px 0;
  font-size:14px;
  color:var(--muted);
  text-transform:uppercase;
  letter-spacing:0.5px;
}
.pdf-detail-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:12px;
}
.pdf-detail-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px;
  background:rgba(255,255,255,0.03);
  border-radius:8px;
  border-left:3px solid var(--accent);
}
.pdf-detail-item.warning{border-left-color:var(--warning);}
.pdf-detail-item.danger{border-left-color:var(--danger);}
.pdf-detail-item.success{border-left-color:var(--success);}
.pdf-detail-label{
  font-size:12px;
  color:var(--muted);
}
.pdf-detail-value{
  font-size:16px;
  font-weight:700;
  color:var(--text);
}
.pdf-alert{
  background:rgba(239,68,68,0.1);
  border:1px solid rgba(239,68,68,0.3);
  color:#fecaca;
  padding:12px;
  border-radius:8px;
  margin:12px 0;
  font-size:13px;
}
.pdf-alert.warning{
  background:rgba(245,158,11,0.1);
  border-color:rgba(245,158,11,0.3);
  color:#fde68a;
}

/* Yeni: Kart tablosu ve KMH stilleri */
.card-details-table {
  width:100%;
  border-collapse:collapse;
  margin-top:12px;
  font-size:12px;
}
.card-details-table th {
  background:rgba(59,130,246,0.1);
  color:var(--accent);
  padding:8px;
  text-align:left;
  font-weight:600;
}
.card-details-table td {
  padding:8px;
  border-bottom:1px solid rgba(255,255,255,0.05);
}
.card-details-table tr:hover {
  background:rgba(255,255,255,0.02);
}
.kmh-card {
  background:linear-gradient(135deg, rgba(6,182,212,0.1), rgba(59,130,246,0.1));
  border:1px solid rgba(6,182,212,0.3);
  border-radius:12px;
  padding:16px;
  margin-top:16px;
}
.progress-bar-bg {
  background:rgba(0,0,0,0.3);
  border-radius:10px;
  height:24px;
  overflow:hidden;
  margin-top:8px;
  position:relative;
}
.progress-bar-fill {
  height:100%;
  border-radius:10px;
  transition:width 0.5s ease;
  display:flex;
  align-items:center;
  justify-content:flex-end;
  padding-right:8px;
  font-size:12px;
  font-weight:700;
}

/* LOGIN */
#loginScreen{
  position:fixed;inset:0;background:linear-gradient(135deg,#0f172a,#1e3a8a);
  display:flex;align-items:center;justify-content:center;z-index:9999;
}
.login-box{
  background:var(--card);padding:40px;border-radius:16px;width:90%;max-width:400px;
  border:1px solid rgba(255,255,255,0.1);
}
.login-title{font-size:28px;font-weight:700;margin-bottom:8px}
.login-subtitle{color:var(--muted);margin-bottom:24px}
.input-group{margin-bottom:16px}
.input-group label{display:block;margin-bottom:6px;font-size:12px;color:var(--muted);text-transform:uppercase}
.input-group input{
  width:100%;padding:14px;background:#1f2937;border:1px solid rgba(255,255,255,0.1);
  border-radius:8px;color:var(--text);font-size:15px;
}

/* RESULTS */
.result-box{
  margin-top:20px;padding:24px;border-radius:16px;border:1px solid rgba(255,255,255,0.1);
  background:linear-gradient(180deg,rgba(30,41,59,0.5),var(--card));display:none;
}
.result-box.show{display:block;animation:fadeIn 0.5s}
.result-approve{border-color:rgba(16,185,129,0.3);background:linear-gradient(180deg,rgba(16,185,129,0.1),var(--card))}
.result-gm{border-color:rgba(245,158,11,0.3);background:linear-gradient(180deg,rgba(245,158,11,0.1),var(--card))}
.result-reject{border-color:rgba(239,68,68,0.3);background:linear-gradient(180deg,rgba(239,68,68,0.1),var(--card))}

.decision-badge{
  display:inline-block;padding:12px 24px;border-radius:12px;font-size:24px;font-weight:800;
  margin-bottom:16px;box-shadow:0 4px 12px rgba(0,0,0,0.3);
}
.decision-approve{background:var(--success);color:black}
.decision-gm{background:var(--warning);color:black}
.decision-reject{background:var(--danger);color:white}

.info-grid{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin:20px 0;
}
.info-item{
  background:rgba(0,0,0,0.3);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.05);
}
.info-item .label{font-size:11px;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px}
.info-item .value{font-size:24px;font-weight:700}

.findex-analysis{
  background:rgba(6,182,212,0.1);border:1px solid rgba(6,182,212,0.2);
  border-radius:12px;padding:20px;margin:20px 0;
}
.findex-bar{
  height:20px;background:rgba(0,0,0,0.3);border-radius:10px;overflow:hidden;margin-top:12px;
}
.findex-fill{
  height:100%;border-radius:10px;transition:width 1s ease;
}
.findex-excellent{background:linear-gradient(90deg,#10b981,#059669)}
.findex-good{background:linear-gradient(90deg,#3b82f6,#2563eb)}
.findex-mid{background:linear-gradient(90deg,#f59e0b,#d97706)}
.findex-bad{background:linear-gradient(90deg,#ef4444,#dc2626)}
.findex-risk{background:linear-gradient(90deg,#7c2d12,#991b1b)}

.red-details{
  background:rgba(239,68,68,0.05);border:1px solid rgba(239,68,68,0.2);
  border-radius:16px;padding:24px;margin-top:20px;
}
.red-reason{
  display:flex;gap:12px;margin-bottom:12px;padding:16px;background:rgba(0,0,0,0.2);
  border-radius:8px;border-left:3px solid var(--danger);
}
.red-reason.solution{border-left-color:var(--success);background:rgba(16,185,129,0.05)}
.badge-tag{
  display:inline-block;padding:4px 10px;border-radius:4px;font-size:11px;font-weight:700;
  white-space:nowrap;text-transform:uppercase;
}

/* TABLES */
table{width:100%;border-collapse:collapse;font-size:13px;margin-top:16px;background:rgba(0,0,0,0.2);border-radius:12px;overflow:hidden}
th,td{padding:14px 12px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.05)}
th{background:rgba(0,0,0,0.4);color:var(--muted);font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:0.5px}
tr:hover{background:rgba(255,255,255,0.02)}
.rating-box{
  display:inline-block;padding:6px 12px;border-radius:6px;font-weight:800;font-size:12px;
}
.rating-excellent{background:#10b981;color:black}
.rating-good{background:#3b82f6;color:white}
.rating-mid{background:#f59e0b;color:black}
.rating-low{background:#ef4444;color:white}
.rating-bad{background:#374151;color:white}

/* CHARTS */
.chart-container{
  background:rgba(0,0,0,0.2);border-radius:16px;padding:24px;margin:20px 0;
  border:1px solid rgba(255,255,255,0.05);position:relative;height:300px;
}
.chart-title{
  font-size:13px;color:var(--muted);margin-bottom:16px;text-transform:uppercase;
  letter-spacing:1px;font-weight:700;display:flex;justify-content:space-between;align-items:center;
}

/* HISTORY */
.history-item{
  padding:16px;background:rgba(0,0,0,0.2);border-radius:12px;margin-bottom:12px;
  border:1px solid rgba(255,255,255,0.05);display:flex;justify-content:space-between;align-items:center;
}
.history-item:hover{background:rgba(255,255,255,0.03)}

/* PRINT */
@media print{
  body{background:white;color:black}
  .card{background:#f8fafc;border:1px solid #e2e8f0;break-inside:avoid}
  .btn,#loginScreen,.tabs{display:none !important}
  #mainApp{display:block !important}
  .result-box{display:block !important;background:#fff !important;border:2px solid #333 !important}
  .chart-container{background:#fff;height:auto !important}
  canvas{max-height:400px !important}
  .red-details{background:#fef2f2 !important;border-color:#fecaca !important}
  .red-details h3{color:#dc2626 !important}
  .info-item{background:#f1f5f9 !important;color:#000 !important}
}

.error-box{
  background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);
  color:#fecaca;padding:12px;border-radius:8px;margin-top:16px;display:none;
}
.success-box{
  background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);
  color:#a7f3d0;padding:12px;border-radius:8px;margin-top:16px;display:none;
}

.leg-item{display:flex;align-items:center;gap:8px;margin-right:16px;font-size:12px;color:var(--muted)}
.leg-dot{width:12px;height:12px;border-radius:50%;}

@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

.pdf-upload-area{
  border:2px dashed rgba(59,130,246,0.3);
  border-radius:12px;
  padding:24px;
  text-align:center;
  background:rgba(59,130,246,0.05);
  margin-bottom:20px;
  transition:all 0.3s;
}
.pdf-upload-area:hover{
  border-color:var(--accent);
  background:rgba(59,130,246,0.1);
}
.pdf-upload-area input[type="file"]{
  display:none;
}
.file-label{
  cursor:pointer;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;
  color:var(--muted);
}
.file-label strong{color:var(--accent)}

.debug-box{
  background:rgba(255,193,7,0.1);
  border:1px solid rgba(255,193,7,0.3);
  color:#ffc107;
  padding:12px;
  border-radius:8px;
  margin-top:16px;
  font-family:monospace;
  font-size:12px;
  display:none;
  max-height:200px;
  overflow-y:auto;
}
</style>
</head>
<body>

<div id="loginScreen">
  <div class="login-box">
    <div class="login-title">Kredi DeÄŸerlendirme Sistemi</div>
    <div class="login-subtitle">GiriÅŸ yapÄ±nÄ±z</div>
    <div class="input-group">
      <label>KullanÄ±cÄ± AdÄ±</label>
      <input type="text" id="lUser" placeholder="KullanÄ±cÄ± adÄ±">
    </div>
    <div class="input-group">
      <label>Åifre</label>
      <input type="password" id="lPass" placeholder="Åifre">
    </div>
    <button class="btn btn-primary" style="width:100%" onclick="doLogin()">GiriÅŸ Yap</button>
  </div>
</div>

<div id="mainApp" class="container" style="display:none;">
  
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('evaluate',this)">DeÄŸerlendirme</button>
    <button class="tab-btn" onclick="switchTab('history',this)">MÃ¼ÅŸteri GeÃ§miÅŸi</button>
    <button class="tab-btn" onclick="switchTab('findex',this)">Findex Analizi</button>
  </div>

  <!-- EVALUATE TAB - MÃ¼ÅŸteri Bilgileri GÃ¼Ã§lendirildi -->
  <div id="evaluateTab">
    <div class="card">
      <div class="top-actions">
        <div>
          <h1>Bireysel Ä°htiyaÃ§ Kredisi DeÄŸerlendirme</h1>
          <h2>Banka iÃ§ risk rating ve limit analizi</h2>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-secondary" onclick="searchCustomer()">ğŸ” MÃ¼ÅŸteri Ara</button>
          <button class="btn btn-orange" onclick="document.getElementById('findexPdfInput').click()">ğŸ“„ PDF Oku</button>
          <button class="btn btn-warning" onclick="resetForm()">ğŸ”„ SÄ±fÄ±rla</button>
          <button class="btn btn-primary" onclick="calculate()">ğŸ“Š Analiz Yap</button>
          <button class="btn btn-success" onclick="saveCustomer()">ğŸ’¾ Kaydet</button>
          <button class="btn btn-secondary" onclick="window.print()">ğŸ–¨ï¸ YazdÄ±r</button>
        </div>
      </div>

      <div class="form-grid">
        <!-- MÃ¼ÅŸteri Kimlik Bilgileri - Ã–ne Ã‡Ä±karÄ±ldÄ± -->
        <div class="form-group" style="grid-column: 1 / -1; background:rgba(59,130,246,0.05); padding:16px; border-radius:8px; border:1px solid rgba(59,130,246,0.2);">
          <h3 style="margin-bottom:12px; color:var(--accent);">ğŸ‘¤ MÃ¼ÅŸteri Kimlik Bilgileri</h3>
          <div class="form-grid" style="margin-top:12px;">
            <div class="form-group" style="margin:0;">
              <label>TC Kimlik No <span style="color:var(--danger)">*</span></label>
              <input type="text" id="tc" maxlength="11" placeholder="11 hane" onblur="loadCustomerData()" oninput="maskTC(this)" class="tc-masked">
              <small style="color:var(--muted); font-size:11px; margin-top:4px; display:block;">* GÃ¼venlik iÃ§in son 2 hane gizli kalÄ±r</small>
            </div>
            <div class="form-group" style="margin:0;">
              <label>Ad Soyad <span style="color:var(--danger)">*</span></label>
              <input type="text" id="fullName" placeholder="MÃ¼ÅŸteri adÄ± soyadÄ±" style="text-transform:uppercase; font-weight:600;">
            </div>
            <div class="form-group" style="margin:0;">
              <label>Telefon</label>
              <input type="text" id="phone" placeholder="05XX XXX XX XX">
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>DeÄŸerlendirme BankasÄ±</label>
          <select id="bank">
            <option value="all">TÃ¼m Bankalar (KarÅŸÄ±laÅŸtÄ±rma)</option>
            <option value="HAL" selected>Halkbank (Esnaf Dostu)</option>
            <option value="ZIR">Ziraat BankasÄ±</option>
            <option value="IS">Ä°ÅŸ BankasÄ±</option>
            <option value="VAK">VakÄ±fbank</option>
            <option value="GAR">Garanti BBVA</option>
            <option value="YK">YapÄ± Kredi</option>
            <option value="AKB">Akbank (KatÄ±)</option>
            <option value="QNB">QNB Finansbank</option>
          </select>
        </div>

        <div class="form-group">
          <label>MÃ¼ÅŸteri TÃ¼rÃ¼</label>
          <select id="customerType">
            <option value="new" selected>Ä°lk Kez Kredi (Clean Slate)</option>
            <option value="salary">MaaÅŸ MÃ¼ÅŸterisi</option>
            <option value="artisan">Esnaf/Sanatkar</option>
            <option value="pension">Emekli</option>
            <option value="corporate">Ticari/TÃ¼zel</option>
          </select>
        </div>
        <div class="form-group">
          <label>Findeks Skoru (0-1900)</label>
          <input type="number" id="findeks" placeholder="PDF'den otomatik doldurulur" min="0" max="1900" oninput="updateFindexPreview()">
        </div>
        <div class="form-group">
          <label>AylÄ±k Net Gelir (TL)</label>
          <input type="number" id="income" placeholder="Ã–rn: 150000" min="0">
        </div>
        <div class="form-group">
          <label>Ä°stenen Tutar (TL)</label>
          <input type="number" id="requested" placeholder="Ã–rn: 400000" min="1000">
        </div>

        <div class="form-group">
          <label>Mevcut AylÄ±k Taksit (TL)</label>
          <input type="number" id="currentInst" value="0" min="0" placeholder="PDF'den otomatik hesaplanÄ±r">
        </div>
        <div class="form-group">
          <label>Meslek/SektÃ¶r</label>
          <select id="job">
            <option value="public">Kamu Memuru</option>
            <option value="private">Ã–zel SektÃ¶r</option>
            <option value="self" selected>Serbest/Esnaf</option>
            <option value="retail">Perakende</option>
            <option value="construction">Ä°nÅŸaat</option>
            <option value="tourism">Turizm</option>
          </select>
        </div>
        <div class="form-group">
          <label>Ä°ÅŸ SÃ¼resi</label>
          <select id="workDuration">
            <option value="0-6">0-6 ay</option>
            <option value="6-12">6-12 ay</option>
            <option value="12-24">1-2 yÄ±l</option>
            <option value="24+" selected>2+ yÄ±l</option>
          </select>
        </div>
        <div class="form-group">
          <label>Konut Durumu</label>
          <select id="housing">
            <option value="rent" selected>KiracÄ±</option>
            <option value="family">Aile Evi</option>
            <option value="owner">Ev Sahibi</option>
          </select>
        </div>

        <div class="form-group">
          <label>Aktif Kredi/Kart SayÄ±sÄ±</label>
          <input type="number" id="loanCount" value="0" min="0" max="20" placeholder="PDF'den otomatik">
        </div>
        <div class="form-group">
          <label>Son 1 YÄ±l Gecikme</label>
          <select id="delay">
            <option value="0" selected>Yok</option>
            <option value="1">1-2 defa (1-30 gÃ¼n)</option>
            <option value="3">3+ defa veya 30+ gÃ¼n</option>
          </select>
        </div>
        <div class="form-group">
          <label>Son 45G Kredi Red?</label>
          <select id="recentReject">
            <option value="no" selected>HayÄ±r</option>
            <option value="yes">Evet</option>
          </select>
        </div>
        <div class="form-group">
          <label>Aktif Ä°cra/Takip?</label>
          <select id="legalFollow">
            <option value="no" selected>HayÄ±r (Temiz)</option>
            <option value="small">10.000 TL altÄ±</option>
            <option value="medium">10.000-50.000 TL</option>
            <option value="high">50.000 TL Ã¼zeri</option>
          </select>
        </div>
      </div>

      <div id="autoFillInfo" style="display:none;margin-top:16px;padding:12px;background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);border-radius:8px;color:#a7f3d0;font-size:13px;">
        <strong>âœ… PDF'den Otomatik Doldurulan Bilgiler:</strong> Findeks Skoru, Kredi SayÄ±sÄ±, BorÃ§ TutarÄ± ve Gecikme Durumu PDF'den alÄ±narak yukarÄ±daki alanlara otomatik yazÄ±ldÄ±.
      </div>

      <div id="findexPreview" class="findex-analysis" style="display:none;">
        <h3>ğŸ“Š Findex Ã–n DeÄŸerlendirmesi</h3>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <span id="findexStatus">Bilinmiyor</span>
          <span id="findexRisk" style="font-weight:700;">-</span>
        </div>
        <div class="findex-bar">
          <div id="findexBar" class="findex-fill" style="width:0%"></div>
        </div>
        <div style="margin-top:12px;font-size:13px;color:var(--muted);" id="findexAdvice"></div>
      </div>

      <div id="errorBox" class="error-box"></div>
      <div id="successBox" class="success-box"></div>
    </div>

    <!-- RESULTS -->
    <div id="resultBox" class="card result-box">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:16px;">
        <div>
          <div id="decisionBadge" class="decision-badge">KARAR</div>
          <div style="color:var(--muted);font-size:14px;margin-top:4px;">
            <span id="bestBankName">-</span> | 
            <span id="decisionDate">-</span>
          </div>
        </div>
        <div style="text-align:right;">
          <div style="font-size:48px;font-weight:800;" id="confidencePercent">-%</div>
          <div style="font-size:12px;color:var(--muted);">GÃ¼ven Skoru</div>
        </div>
      </div>

      <div style="display:flex;gap:8px;margin:20px 0;flex-wrap:wrap;" id="legendContainer">
        <!-- Dynamic legend -->
      </div>

      <div class="info-grid">
        <div class="info-item">
          <div class="label">Banka Ä°Ã§ Rating</div>
          <div class="value" id="ratingValue">-</div>
        </div>
        <div class="info-item">
          <div class="label">Ã–nerilen Limit</div>
          <div class="value" id="limitValue">-</div>
        </div>
        <div class="info-item">
          <div class="label">DTI OranÄ±</div>
          <div class="value" id="dtiValue">-%</div>
        </div>
        <div class="info-item">
          <div class="label">Risk Skoru</div>
          <div class="value" id="scoreValue">-</div>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-title">
          <span>Banka KarÅŸÄ±laÅŸtÄ±rma</span>
          <div style="display:flex;">
            <div class="leg-item"><div class="leg-dot" style="background:#10b981"></div>Onay</div>
            <div class="leg-item"><div class="leg-dot" style="background:#f59e0b"></div>GM</div>
            <div class="leg-item"><div class="leg-dot" style="background:#ef4444"></div>Ret</div>
          </div>
        </div>
        <canvas id="mainChart"></canvas>
      </div>

      <div id="rejectAnalysis"></div>

      <h3 style="margin:24px 0 16px 0;">TÃ¼m Banka DeÄŸerlendirmeleri</h3>
      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>Banka</th>
              <th>Karar</th>
              <th>GÃ¼ven %</th>
              <th>Ä°Ã§ Rating</th>
              <th>Limit</th>
              <th>GerekÃ§e</th>
            </tr>
          </thead>
          <tbody id="resultsTable"></tbody>
        </table>
      </div>

      <div class="chart-container" style="margin-top:24px;">
        <div class="chart-title">Risk Profili Radar Analizi</div>
        <canvas id="radarChart"></canvas>
      </div>

      <!-- PRINT SECTION -->
      <div id="printSection" style="margin-top:40px;padding-top:40px;border-top:2px dashed rgba(255,255,255,0.2);display:none;" class="print-only">
        <h2>MÃ¼ÅŸteri Kredi Raporu</h2>
        <p><strong>MÃ¼ÅŸteri:</strong> <span id="printName"></span> | <strong>TC:</strong> <span id="printTc"></span></p>
        <p><strong>Tarih:</strong> <span id="printDate"></span></p>
        <p><strong>DeÄŸerlendirme:</strong> <span id="printDecision"></span></p>
      </div>
    </div>
  </div>

  <!-- HISTORY TAB -->
  <div id="historyTab" style="display:none;">
    <div class="card">
      <h1>MÃ¼ÅŸteri GeÃ§miÅŸi</h1>
      <div style="display:flex;gap:12px;margin-bottom:20px;">
        <input type="text" id="searchTcInput" placeholder="TC veya Ä°sim ile ara" style="max-width:300px;" class="form-group input">
        <button class="btn btn-primary" onclick="searchHistory()">Ara</button>
        <button class="btn btn-secondary" onclick="loadAllHistory()">TÃ¼mÃ¼nÃ¼ GÃ¶ster</button>
      </div>
      <div id="historyList"></div>
    </div>
  </div>

  <!-- FINDEX TAB - GeliÅŸtirilmiÅŸ Hali -->
  <div id="findexTab" style="display:none;">
    <div class="card">
      <h1>Findex (KKB) Detay Analizi</h1>
      
      <!-- PDF YÃ¼kleme AlanÄ± -->
      <div class="pdf-upload-area" onclick="document.getElementById('findexPdfInput').click()">
        <input type="file" id="findexPdfInput" accept=".pdf" onchange="processFindexPDF(this)">
        <label class="file-label">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--accent)">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10 9 9 9 8 9"></polyline>
          </svg>
          <strong>Findeks PDF Raporu YÃ¼kle</strong>
          <span>KKB raporunuzu sÃ¼rÃ¼kleyin veya tÄ±klayÄ±n</span>
          <span style="font-size:11px;opacity:0.7;margin-top:4px;">PDF'den otomatik skor, kredi kartlarÄ±, KMH ve borÃ§ bilgileri okunur</span>
        </label>
      </div>

      <div id="pdfProcessingStatus" style="display:none;margin-bottom:16px;padding:12px;background:rgba(59,130,246,0.1);border-radius:8px;border:1px solid rgba(59,130,246,0.3);text-align:center;">
        <span style="color:var(--accent)">ğŸ“„ PDF analiz ediliyor...</span>
      </div>

      <!-- PDF Detay Raporu Burada GÃ¶sterilecek -->
      <div id="pdfDetailReport"></div>

      <div id="debugBox" class="debug-box"></div>

      <div class="form-grid" style="margin-bottom:24px;margin-top:24px;">
        <div class="form-group">
          <label>Findeks Skoru Girin</label>
          <input type="number" id="analyzeFindex" placeholder="0-1900" min="0" max="1900">
        </div>
        <div class="form-group" style="display:flex;align-items:flex-end;">
          <button class="btn btn-primary" onclick="analyzeFindexDetail()" style="width:100%;">Analiz Et</button>
        </div>
      </div>
      <div id="findexDetailResult"></div>
    </div>
  </div>

</div>

<script>
const BANKS = {
  HAL: { 
    name: "Halkbank", 
    ratingName: "A-E Skala",
    multipliers: {limit: 5.5, risk: 0.9},
    minFindeks: 1000,
    icraLimit: 25000,
    color: "#dc143c",
    features: ["Esnaf dostu", "1000+ findeks yeterli", "Ä°cra toleransÄ± yÃ¼ksek"],
    algorithm: "esnaf_friendly"
  },
  ZIR: { 
    name: "Ziraat", 
    ratingName: "1-5 Sistem",
    multipliers: {limit: 5, risk: 0.95},
    minFindeks: 1050,
    icraLimit: 20000,
    color: "#e60000",
    features: ["TarÄ±m destekli", "Kamu Ã§alÄ±ÅŸanlarÄ±na Ã¶zel"],
    algorithm: "public_focused"
  },
  IS: { 
    name: "Ä°ÅŸ BankasÄ±", 
    ratingName: "AAA-D",
    multipliers: {limit: 4.5, risk: 1.0},
    minFindeks: 1150,
    icraLimit: 0,
    color: "#003087",
    features: ["MaaÅŸ mÃ¼ÅŸterisi avantajÄ±", "Dijital deÄŸerlendirme"],
    algorithm: "salary_focused"
  },
  VAK: { 
    name: "VakÄ±fbank", 
    ratingName: "S1-S5",
    multipliers: {limit: 4.8, risk: 0.95},
    minFindeks: 1050,
    icraLimit: 15000,
    color: "#eab308",
    features: ["Orta riskli profiller", "Emekli dostu"],
    algorithm: "balanced"
  },
  GAR: { 
    name: "Garanti", 
    ratingName: "Plat-Bronz",
    multipliers: {limit: 4, risk: 1.1},
    minFindeks: 1200,
    icraLimit: 0,
    color: "#16a34a",
    features: ["Dijital skor aÄŸÄ±rlÄ±klÄ±", "1600+ otomatik onay"],
    algorithm: "digital_first"
  },
  YK: { 
    name: "YapÄ± Kredi", 
    ratingName: "A1-C",
    multipliers: {limit: 4.2, risk: 1.05},
    minFindeks: 1180,
    icraLimit: 5000,
    color: "#ea580c",
    features: ["Kart iliÅŸkisi Ã¶nemli", "YÃ¼ksek limit tercihi"],
    algorithm: "card_focused"
  },
  AKB: { 
    name: "Akbank", 
    ratingName: "R1-R6",
    multipliers: {limit: 3.5, risk: 1.2},
    minFindeks: 1250,
    icraLimit: 0,
    color: "#0369a1",
    features: ["En katÄ± politikalar", "1500+ findeks ÅŸart"],
    algorithm: "strict"
  },
  QNB: { 
    name: "QNB", 
    ratingName: "PPC Skor",
    multipliers: {limit: 4.5, risk: 0.9},
    minFindeks: 1200,
    icraLimit: 10000,
    color: "#9333ea",
    features: ["YÃ¼ksek gelir alternatifi", "POS cirosu deÄŸerlendirmesi"],
    algorithm: "income_focused"
  }
};

let charts = {};
let currentResults = [];
let currentCustomer = {};
let lastPdfData = null; // Son okunan PDF verilerini sakla

function el(id) { return document.getElementById(id); }

// YENÄ°: TC Kimlik No Maskeleme Fonksiyonu
function maskTC(input) {
  let value = input.value.replace(/\D/g, ''); // Sadece rakamlar
  if (value.length > 11) value = value.slice(0, 11);
  
  // GÃ¶rsel maskeli deÄŸer (son 2 hane gizli)
  if (value.length > 2) {
    const masked = value.slice(0, value.length - 2).replace(/./g, '*') + value.slice(-2);
    // GerÃ§ek deÄŸeri data attribute'unda sakla
    input.setAttribute('data-real-value', value);
    // GÃ¶sterimi gÃ¼ncelle (opsiyonel: ÅŸu an direkt deÄŸer deÄŸiÅŸtirilmiyor, sadece girilen deÄŸer kaydediliyor)
  }
  
  input.value = value;
}

// YENÄ°: TC Kimlik No GÃ¼venli GÃ¶sterim (******98765 formatÄ±nda)
function getMaskedTC(tc) {
  if (!tc || tc.length !== 11) return tc;
  return "*****" + tc.slice(5);
}

function debugLog(msg) {
  console.log(msg);
  const debugBox = el("debugBox");
  if(debugBox) {
    debugBox.style.display = "block";
    debugBox.innerHTML += msg + "<br>";
  }
}

function doLogin() {
  const u = el("lUser").value.trim();
  const p = el("lPass").value.trim();
  if(u === "sedat" && p === "4040") {
    el("loginScreen").style.display = "none";
    el("mainApp").style.display = "block";
  } else {
    alert("HatalÄ± giriÅŸ bilgileri");
  }
}

function switchTab(tab, btn) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  
  ['evaluateTab','historyTab','findexTab'].forEach(t => el(t).style.display = 'none');
  el(tab + 'Tab').style.display = 'block';
  
  if(tab === 'history') loadAllHistory();
}

function showError(msg) {
  const box = el("errorBox");
  box.textContent = msg;
  box.style.display = "block";
  setTimeout(() => box.style.display = "none", 5000);
}

function showSuccess(msg) {
  const box = el("successBox");
  box.textContent = msg;
  box.style.display = "block";
  setTimeout(() => box.style.display = "none", 5000);
}

function resetForm() {
  document.querySelectorAll('input[type="text"], input[type="number"]').forEach(inp => {
    if(!['lUser','lPass'].includes(inp.id)) inp.value = '';
  });
  document.querySelectorAll('select').forEach(sel => {
    if(sel.options.length > 0) sel.selectedIndex = 0;
  });
  el("resultBox").classList.remove("show");
  el("currentInst").value = "0";
  el("loanCount").value = "0";
  el("findexPreview").style.display = "none";
  el("autoFillInfo").style.display = "none";
  currentResults = [];
  currentCustomer = {};
  lastPdfData = null;
}

function updateFindexPreview() {
  const score = parseInt(el("findeks").value) || 0;
  const preview = el("findexPreview");
  const bar = el("findexBar");
  const status = el("findexStatus");
  const risk = el("findexRisk");
  const advice = el("findexAdvice");
  
  if(score > 0) {
    preview.style.display = "block";
    bar.style.width = (score/1900*100) + "%";
    
    if(score >= 1700) {
      bar.className = "findex-fill finex-excellent";
      status.textContent = "MÃ¼kemmel (1700+)";
      risk.textContent = "DÃœÅÃœK RÄ°SK";
      risk.style.color = "#10b981";
      advice.textContent = "TÃ¼m bankalarda A/1 rating alÄ±rsÄ±nÄ±z. En yÃ¼ksek limitler ve en dÃ¼ÅŸÃ¼k faizler size Ã¶zel.";
    } else if(score >= 1400) {
      bar.className = "findex-fill finex-good";
      status.textContent = "Ä°yi (1400-1699)";
      risk.textContent = "ORTA-DÃœÅÃœK RÄ°SK";
      risk.style.color = "#3b82f6";
      advice.textContent = "Standart onay alÄ±rsÄ±nÄ±z. 5-6 maaÅŸ limit Ã§arpanÄ± uygulanÄ±r.";
    } else if(score >= 1200) {
      bar.className = "findex-fill finex-mid";
      status.textContent = "Orta (1200-1399)";
      risk.textContent = "ORTA RÄ°SK";
      risk.style.color = "#f59e0b";
      advice.textContent = "GM (GÃ¶rÃ¼ÅŸmeli Onay) ile sonuÃ§lanabilir. Limit Ã§arpanÄ± 4-5 arasÄ±.";
    } else if(score >= 1000) {
      bar.className = "findex-fill finex-bad";
      status.textContent = "Riskli (1000-1199)";
      risk.textContent = "YÃœKSEK RÄ°SK";
      risk.style.color = "#ef4444";
      advice.textContent = "Sadece Halkbank, Ziraat gibi kamu bankalarÄ± deÄŸerlendirir. Teminat/kefil gerekli.";
    } else {
      bar.className = "findex-fill finex-risk";
      status.textContent = "Ã‡ok Riskli (<1000)";
      risk.textContent = "KABUL EDÄ°LEMEZ";
      risk.style.color = "#7c2d12";
      advice.textContent = "Kredi almanÄ±z Ã§ok zor. Ã–nce findeksinizi 1000+ Ã§Ä±karÄ±n. Acil nakit iÃ§in yapÄ±landÄ±rma dÃ¼ÅŸÃ¼nÃ¼n.";
    }
  } else {
    preview.style.display = "none";
  }
}

function calculateBankSpecific(bankKey, data) {
  const bank = BANKS[bankKey];
  let baseScore = 500;
  let limit = data.income * bank.multipliers.limit;
  
  let findeksImpact = 0;
  if(data.findeks >= 1700) findeksImpact = 250;
  else if(data.findeks >= 1400) findeksImpact = 200;
  else if(data.findeks >= 1200) findeksImpact = 150;
  else if(data.findeks >= 1000) findeksImpact = 50;
  else findeksImpact = -100;
  
  baseScore += findeksImpact;
  
  if(data.findeks < bank.minFindeks) {
    baseScore -= (bank.minFindeks - data.findeks) * 0.5;
  }
  
  let incomeMultiplier = 1;
  if(data.income > 100000) incomeMultiplier = 1.3;
  else if(data.income > 50000) incomeMultiplier = 1.1;
  
  baseScore += (data.income / 1000) * bank.multipliers.risk;
  
  if(bank.algorithm === "esnaf_friendly" && (data.job === "self" || data.customerType === "artisan")) {
    baseScore += 80;
    limit *= 1.2;
  }
  
  if(bank.algorithm === "strict" && data.findeks < 1400) {
    baseScore -= 100;
  }
  
  if(bank.algorithm === "digital_first" && data.findeks < 1600) {
    baseScore -= 50;
  }
  
  if(bank.algorithm === "public_focused" && data.job === "public") {
    baseScore += 60;
    limit *= 1.15;
  }
  
  if(data.legal !== "no") {
    const icraAmount = data.legal === "small" ? 5000 : data.legal === "medium" ? 30000 : 75000;
    if(icraAmount > bank.icraLimit) {
      baseScore -= 200;
    } else {
      baseScore -= 50;
      limit *= 0.5;
    }
  }
  
  if(data.workDuration === "24+") baseScore += 40;
  if(data.housing === "owner") baseScore += 30;
  if(data.delay !== "0") baseScore -= (parseInt(data.delay) * 40);
  if(data.reject === "yes") baseScore -= 80;
  if(data.loanCount > 3) baseScore -= (data.loanCount - 3) * 20;
  
  if(data.findeks < 1200) limit *= 0.7;
  if(data.findeks < 1000) limit *= 0.5;
  
  limit = Math.floor(limit / 1000) * 1000;
  
  const monthlyPayment = data.requested / 36;
  const totalDTI = ((data.currentInst + monthlyPayment) / data.income) * 100;
  
  let decision, confidence;
  const finalScore = Math.max(0, Math.min(1000, baseScore));
  
  if(data.legal !== "no" && (data.legal === "high" || (data.legal === "medium" && bank.icraLimit < 20000))) {
    decision = "RET";
    confidence = 15;
  } else if(finalScore >= 750 && data.requested <= limit * 1.1 && totalDTI < 55) {
    decision = "ONAY";
    confidence = 60 + ((finalScore - 750) / 250) * 35;
  } else if(finalScore >= 600 && totalDTI < 65) {
    decision = "GM";
    confidence = 40 + ((finalScore - 600) / 400) * 30;
    limit = Math.min(limit, data.requested * 0.85);
  } else {
    decision = "RET";
    confidence = Math.max(5, (finalScore / 1000) * 30);
  }
  
  let rating;
  if(bankKey === "HAL") rating = finalScore >= 900 ? "A" : finalScore >= 800 ? "B" : finalScore >= 700 ? "C" : finalScore >= 600 ? "D" : "E";
  else if(bankKey === "ZIR") rating = finalScore >= 900 ? "1" : finalScore >= 800 ? "2" : finalScore >= 700 ? "3" : finalScore >= 600 ? "4" : "5";
  else if(bankKey === "AKB") rating = finalScore >= 850 ? "R1" : finalScore >= 750 ? "R2" : finalScore >= 650 ? "R3" : finalScore >= 550 ? "R4" : "R5-R6";
  else rating = finalScore >= 850 ? "A/1" : finalScore >= 750 ? "B/2" : finalScore >= 650 ? "C/3" : finalScore >= 550 ? "D/4" : "E/5";
  
  return {
    bank: bankKey,
    bankName: bank.name,
    decision: decision,
    confidence: Math.round(confidence),
    score: finalScore,
    rating: rating,
    limit: limit,
    dti: totalDTI.toFixed(1),
    color: bank.color,
    reasoning: generateReasoning(bankKey, data, decision, finalScore)
  };
}

function generateReasoning(bank, data, decision, score) {
  const reasons = [];
  const b = BANKS[bank];
  
  if(data.legal !== "no") reasons.push("Ä°cra kaydÄ±");
  if(data.findeks < b.minFindeks) reasons.push(`DÃ¼ÅŸÃ¼k findeks (min:${b.minFindeks})`);
  if(data.reject === "yes") reasons.push("Son red kaydÄ±");
  if(data.job === "construction") reasons.push("Riskli sektÃ¶r");
  if(score > 750) reasons.push("GÃ¼Ã§lÃ¼ profil");
  if(b.algorithm === "esnaf_friendly" && (data.job === "self")) reasons.push("Esnaf avantajÄ±");
  
  return reasons.join(", ") || "Standart deÄŸerlendirme";
}

function calculate() {
  const fullName = el("fullName").value.trim();
  const tcRaw = el("tc").value.trim();
  
  const data = {
    tc: tcRaw,
    findeks: parseInt(el("findeks").value) || 0,
    income: parseInt(el("income").value) || 0,
    requested: parseInt(el("requested").value) || 0,
    currentInst: parseInt(el("currentInst").value) || 0,
    customerType: el("customerType").value,
    job: el("job").value,
    workDuration: el("workDuration").value,
    housing: el("housing").value,
    loanCount: parseInt(el("loanCount").value) || 0,
    delay: el("delay").value,
    reject: el("recentReject").value,
    legal: el("legalFollow").value,
    bank: el("bank").value
  };
  
  if(!data.tc || data.tc.length !== 11) { showError("GeÃ§erli TC Kimlik No giriniz (11 hane)"); return; }
  if(!fullName) { showError("MÃ¼ÅŸteri Ad Soyad zorunludur"); return; }
  if(!data.findeks || data.findeks < 0 || data.findeks > 1900) { showError("GeÃ§erli Findeks giriniz"); return; }
  if(!data.income) { showError("GeÃ§erli gelir giriniz"); return; }
  if(!data.requested) { showError("Ä°stenen tutar giriniz"); return; }
  
  const banksToCheck = data.bank === "all" ? Object.keys(BANKS) : [data.bank];
  const results = banksToCheck.map(b => calculateBankSpecific(b, data));
  
  results.sort((a,b) => {
    const order = { "ONAY": 3, "GM": 2, "RET": 1 };
    if(order[b.decision] !== order[a.decision]) return order[b.decision] - order[a.decision];
    return b.confidence - a.confidence;
  });
  
  currentResults = results;
  currentCustomer = { ...data, date: new Date().toLocaleString("tr-TR"), name: fullName };
  
  displayResults(results, data);
}

function displayResults(results, data) {
  const best = results[0];
  const box = el("resultBox");
  
  box.className = "card result-box show " + (best.decision === "ONAY" ? "result-approve" : best.decision === "GM" ? "result-gm" : "result-reject");
  
  const badge = el("decisionBadge");
  badge.className = "decision-badge " + (best.decision === "ONAY" ? "decision-approve" : best.decision === "GM" ? "decision-gm" : "decision-reject");
  badge.textContent = best.decision === "ONAY" ? "âœ… ONAY" : best.decision === "GM" ? "âš ï¸ GM ONAYI" : "âŒ RED";
  
  el("bestBankName").textContent = best.bankName;
  el("decisionDate").textContent = new Date().toLocaleDateString("tr-TR");
  el("confidencePercent").textContent = "%" + best.confidence;
  el("confidencePercent").style.color = best.decision === "ONAY" ? "#10b981" : best.decision === "GM" ? "#f59e0b" : "#ef4444";
  
  const ratingClass = best.score >= 750 ? "rating-excellent" : best.score >= 650 ? "rating-good" : best.score >= 550 ? "rating-mid" : best.score >= 400 ? "rating-low" : "rating-bad";
  el("ratingValue").innerHTML = `<span class="rating-box ${ratingClass}">${best.rating}</span>`;
  el("ratingValue").style.display = "block";
  
  el("limitValue").textContent = best.limit.toLocaleString("tr-TR") + " TL";
  el("dtiValue").textContent = "%" + best.dti;
  el("dtiValue").style.color = parseFloat(best.dti) > 50 ? "#ef4444" : parseFloat(best.dti) > 40 ? "#f59e0b" : "#10b981";
  el("scoreValue").textContent = best.score;
  
  updateCharts(results, data);
  
  el("resultsTable").innerHTML = results.map(r => `
    <tr>
      <td><strong style="color:${r.color}">${r.bankName}</strong></td>
      <td><span style="color:${r.decision==='ONAY'?'#10b981':r.decision==='GM'?'#f59e0b':'#ef4444'};font-weight:700">${r.decision}</span></td>
      <td>%${r.confidence}</td>
      <td><span class="rating-box ${r.score >= 750 ? 'rating-excellent' : r.score >= 650 ? 'rating-good' : r.score >= 550 ? 'rating-mid' : 'rating-low'}">${r.rating}</span></td>
      <td>${r.limit.toLocaleString()} TL</td>
      <td style="font-size:12px;">${r.reasoning}</td>
    </tr>
  `).join("");
  
  if(best.decision === "RET") {
    let html = `<div class="red-details">
      <h3>ğŸš¨ RED Analizi ve Recovery PlanÄ±</h3>`;
    
    if(data.legal !== "no") {
      html += `<div class="red-reason">
        <span class="badge-tag" style="background:#7c2d12;color:white;">Ä°CRA</span>
        <div>
          <div style="font-weight:700;">Aktif Ä°cra/Takip KaydÄ±</div>
          <div style="font-size:13px;color:var(--muted);margin-top:4px;">
            ${data.legal === "high" ? "50.000 TL Ã¼zeri icra" : data.legal === "medium" ? "10.000-50.000 TL arasÄ± icra" : "10.000 TL altÄ± icra"} mevcut. 
            ${BANKS[best.bank].name} iÃ§in tolerans limiti: ${BANKS[best.bank].icraLimit.toLocaleString()} TL.
          </div>
        </div>
      </div>`;
    }
    
    if(data.findeks < 1000) {
      html += `<div class="red-reason solution">
        <span class="badge-tag" style="background:#f59e0b;color:black;">FIRSAT</span>
        <div style="font-size:13px;">
          <strong>Temiz KayÄ±t AvantajÄ±:</strong> HiÃ§ kredi kullanmadÄ±ysanÄ±z "Clean Slate" olarak Halkbank/Ziraat'e 30.000 TL altÄ± baÅŸvuru yapÄ±n. 
          Kredi kartÄ± alÄ±p dÃ¼zenli kullanÄ±n, 6 ay sonra tekrar baÅŸvurun.
        </div>
      </div>`;
    }
    
    html += `</div>`;
    el("rejectAnalysis").innerHTML = html;
  } else {
    el("rejectAnalysis").innerHTML = "";
  }
  
  // Print iÃ§in bilgileri doldur
  el("printName").textContent = currentCustomer.name || '-';
  el("printTc").textContent = getMaskedTC(data.tc);
  el("printDate").textContent = new Date().toLocaleDateString("tr-TR");
  el("printDecision").textContent = best.decision + " (" + best.bankName + ")";
}

function updateCharts(results, data) {
  if(charts.main) charts.main.destroy();
  const ctx1 = el("mainChart").getContext("2d");
  charts.main = new Chart(ctx1, {
    type: 'bar',
    data: {
      labels: results.map(r => r.bankName),
      datasets: [{
        label: 'GÃ¼ven %',
        data: results.map(r => r.confidence),
        backgroundColor: results.map(r => r.decision === 'ONAY' ? '#10b981' : r.decision === 'GM' ? '#f59e0b' : '#ef4444'),
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {legend: {display: false}},
      scales: {
        y: {beginAtZero: true, max: 100, grid: {color: 'rgba(255,255,255,0.1)'}, ticks: {color: '#9ca3af'}},
        x: {grid: {display: false}, ticks: {color: '#9ca3af'}}
      }
    }
  });
  
  if(charts.radar) charts.radar.destroy();
  const ctx2 = el("radarChart").getContext("2d");
  charts.radar = new Chart(ctx2, {
    type: 'radar',
    data: {
      labels: ['Findeks', 'Gelir', 'Ä°stihdam', 'Ã–deme GeÃ§miÅŸi', 'SektÃ¶r', 'Kredi YoÄŸunluÄŸu'],
      datasets: [
        {
          label: 'MÃ¼ÅŸteri',
          data: [
            (data.findeks/1900)*100,
            Math.min((data.income/50000)*100, 100),
            data.workDuration === '24+' ? 100 : data.workDuration === '0-6' ? 30 : 70,
            100 - (parseInt(data.delay)*30),
            data.job === 'public' ? 100 : data.job === 'construction' ? 40 : 70,
            Math.max(0, 100 - (data.loanCount*15))
          ],
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59,130,246,0.2)'
        },
        {
          label: 'Banka Beklentisi',
          data: [70, 60, 80, 90, 60, 70],
          borderColor: 'rgba(255,255,255,0.3)',
          backgroundColor: 'transparent',
          borderDash: [5,5]
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        r: {
          angleLines: {color: 'rgba(255,255,255,0.1)'},
          grid: {color: 'rgba(255,255,255,0.1)'},
          pointLabels: {color: '#9ca3af'},
          ticks: {display: false}
        }
      }
    }
  });
}

function saveCustomer() {
  if(!currentCustomer.tc) {
    showError("Ã–nce analiz yapmalÄ±sÄ±nÄ±z");
    return;
  }
  
  let records = JSON.parse(localStorage.getItem('kredi_records') || '[]');
  const existingIndex = records.findIndex(r => r.tc === currentCustomer.tc);
  const record = {
    ...currentCustomer,
    results: currentResults,
    savedAt: new Date().toISOString()
  };
  
  if(existingIndex >= 0) {
    records[existingIndex] = record;
  } else {
    records.push(record);
  }
  
  localStorage.setItem('kredi_records', JSON.stringify(records));
  showSuccess("MÃ¼ÅŸteri kaydÄ± baÅŸarÄ±yla kaydedildi");
}

function loadCustomerData() {
  const tc = el("tc").value;
  if(tc.length !== 11) return;
  
  const records = JSON.parse(localStorage.getItem('kredi_records') || '[]');
  const record = records.find(r => r.tc === tc);
  
  if(record) {
    el("fullName").value = record.name || '';
    el("findeks").value = record.findeks || '';
    el("income").value = record.income || '';
    el("job").value = record.job || 'private';
    el("customerType").value = record.customerType || 'salary';
    updateFindexPreview();
    showSuccess("MÃ¼ÅŸteri bilgileri yÃ¼klendi");
  }
}

function searchCustomer() {
  const tc = prompt("TC Kimlik No girin:");
  if(tc && tc.length === 11) {
    el("tc").value = tc;
    loadCustomerData();
    switchTab('evaluate', document.querySelector('.tab-btn'));
  }
}

function deleteCustomer(tc) {
  if(!confirm(`${tc} TC numaralÄ± mÃ¼ÅŸteri kaydÄ±nÄ± silmek istediÄŸinize emin misiniz?\n\nBu iÅŸlem geri alÄ±namaz!`)) return;
  
  let records = JSON.parse(localStorage.getItem('kredi_records') || '[]');
  records = records.filter(r => r.tc !== tc);
  localStorage.setItem('kredi_records', JSON.stringify(records));
  loadAllHistory();
  showSuccess("MÃ¼ÅŸteri kaydÄ± baÅŸarÄ±yla silindi");
}

function loadAllHistory() {
  const records = JSON.parse(localStorage.getItem('kredi_records') || '[]');
  const container = el("historyList");
  
  if(records.length === 0) {
    container.innerHTML = '<p style="color:var(--muted);">HenÃ¼z kayÄ±t bulunmamaktadÄ±r.</p>';
    return;
  }
  
  container.innerHTML = records.sort((a,b) => new Date(b.savedAt) - new Date(a.savedAt)).map(r => {
    const bestResult = r.results ? r.results[0] : null;
    return `
      <div class="history-item">
        <div>
          <div style="font-weight:700;">${r.name || 'Ä°simsiz'}</div>
          <div style="font-size:13px;color:var(--muted);">TC: ${getMaskedTC(r.tc)} | ${new Date(r.savedAt).toLocaleDateString('tr-TR')}</div>
          <div style="font-size:13px;margin-top:4px;">
            Findex: ${r.findeks} | Gelir: ${parseInt(r.income).toLocaleString()} TL
          </div>
        </div>
        <div style="text-align:right;">
          <div style="font-size:20px;font-weight:800;color:${bestResult?.decision === 'ONAY' ? '#10b981' : bestResult?.decision === 'GM' ? '#f59e0b' : '#ef4444'}">
            ${bestResult?.decision || '-'}
          </div>
          <div style="display:flex;gap:8px;margin-top:8px;">
            <button class="btn btn-secondary" style="font-size:11px;padding:6px 12px;" onclick="loadHistoryRecord('${r.tc}')">YÃ¼kle</button>
            <button class="btn btn-danger" style="font-size:11px;padding:6px 12px;" onclick="deleteCustomer('${r.tc}')">Sil</button>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function loadHistoryRecord(tc) {
  const records = JSON.parse(localStorage.getItem('kredi_records') || '[]');
  const record = records.find(r => r.tc === tc);
  if(record) {
    el("tc").value = record.tc;
    el("fullName").value = record.name || '';
    el("findeks").value = record.findeks;
    el("income").value = record.income;
    el("requested").value = record.requested;
    el("job").value = record.job;
    el("customerType").value = record.customerType;
    el("workDuration").value = record.workDuration;
    el("housing").value = record.housing;
    el("loanCount").value = record.loanCount;
    el("delay").value = record.delay;
    el("recentReject").value = record.reject;
    el("legalFollow").value = record.legal || 'no';
    
    updateFindexPreview();
    switchTab('evaluate', document.querySelector('.tab-btn'));
    showSuccess("KayÄ±t yÃ¼klendi");
  }
}

function searchHistory() {
  const searchTerm = el("searchTcInput").value.toLowerCase();
  if(!searchTerm) return;
  
  const records = JSON.parse(localStorage.getItem('kredi_records') || '[]');
  const filtered = records.filter(r => 
    r.tc.includes(searchTerm) || 
    (r.name && r.name.toLowerCase().includes(searchTerm))
  );
  
  const container = el("historyList");
  if(filtered.length === 0) {
    container.innerHTML = '<p style="color:var(--muted);">SonuÃ§ bulunamadÄ±.</p>';
    return;
  }
  
  container.innerHTML = filtered.map(r => {
    const bestResult = r.results ? r.results[0] : null;
    return `
      <div class="history-item">
        <div>
          <div style="font-weight:700;">${r.name || 'Ä°simsiz'}</div>
          <div style="font-size:13px;color:var(--muted);">TC: ${getMaskedTC(r.tc)}</div>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-secondary" onclick="loadHistoryRecord('${r.tc}')">YÃ¼kle</button>
          <button class="btn btn-danger" onclick="deleteCustomer('${r.tc}')">Sil</button>
        </div>
      </div>
    `;
  }).join('');
}

// GELÄ°ÅMÄ°Å PDF ANALÄ°Z FONKSÄ°YONU - Kredili Ã¼rÃ¼n detaylarÄ± eklendi
async function processFindexPDF(input) {
  const file = input.files[0];
  if(!file) return;
  
  if(file.type !== 'application/pdf') {
    showError("LÃ¼tfen geÃ§erli bir PDF dosyasÄ± seÃ§in");
    input.value = '';
    return;
  }
  
  const debugBox = el("debugBox");
  if(debugBox) debugBox.innerHTML = "";
  
  el("pdfProcessingStatus").style.display = "block";
  debugLog("PDF iÅŸleme baÅŸladÄ±: " + file.name);
  
  try {
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
    
    let fullText = "";
    const maxPages = Math.min(pdf.numPages, 8); // Kart detaylarÄ± iÃ§in daha fazla sayfa
    
    debugLog("Toplam sayfa: " + pdf.numPages + ", Ä°ÅŸlenecek: " + maxPages);
    
    for(let i = 1; i <= maxPages; i++) {
      try {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map(item => item.str).join(" ");
        fullText += pageText + "\n";
        debugLog("Sayfa " + i + " okundu");
      } catch(e) {
        debugLog("Sayfa " + i + " hatasÄ±: " + e.message);
      }
    }
    
    fullText = fullText.replace(/\s+/g, ' ').trim();
    debugLog("Metin Ã§Ä±karÄ±mÄ± tamamlandÄ±, uzunluk: " + fullText.length);
    
    // PDF VERÄ° Ã‡IKARIMI
    const pdfData = extractPdfData(fullText);
    lastPdfData = pdfData; // Son veriyi sakla
    
    debugLog("Ã‡Ä±karÄ±lan veriler: " + JSON.stringify(pdfData));
    
    // SonuÃ§larÄ± gÃ¶ster
    if(pdfData.findeksScore) {
      // 1. Findex Analizi sekmesini doldur
      displayPdfDetails(pdfData);
      
      // 2. DeÄŸerlendirme formunu otomatik doldur
      fillEvaluationForm(pdfData);
      
      showSuccess(`âœ… PDF Analiz TamamlandÄ±! Findeks: ${pdfData.findeksScore}, Kart SayÄ±sÄ±: ${pdfData.creditCards?.length || 0}, KMH: ${pdfData.kmh?.length || 0}`);
      
    } else {
      showError("PDF'de Findeks skoru tespit edilemedi. LÃ¼tfen manuel olarak girin.");
    }
    
  } catch(error) {
    console.error("PDF okuma hatasÄ±:", error);
    debugLog("HATA: " + error.message);
    showError("PDF okunurken hata oluÅŸtu: " + error.message);
  } finally {
    el("pdfProcessingStatus").style.display = "none";
    input.value = '';
  }
}

function extractPdfData(text) {
  const data = {
    findeksScore: null,
    totalLimit: 0,
    totalDebt: 0,
    productCount: 0,
    financialInstitutions: 0,
    delayStatus: 'clean',
    maxDelayDays: 0,
    lastFollowDate: null,
    utilizationRate: 0,
    // YENÄ° ALANLAR
    creditCards: [],
    kmh: [], // Kredili Mevduat HesaplarÄ±
    loans: [] // DiÄŸer krediler
  };
  
  // 1. Findeks Skoru
  const findeksPatterns = [
    /Findeks\s*Kredi\s*Notunuz.*?[#]?\s*(\d{3,4})/i,
    /[#]\s*(\d{3,4})\s*Findeks/i,
    /Findeks\s*Kredi\s*Notu['\s]*(\d{3,4})/i,
    /Risk\s*Skor[uÃ¼]?\s*:?\s*(\d{1,4})/i
  ];
  
  for(let pattern of findeksPatterns) {
    const match = text.match(pattern);
    if(match && match[1]) {
      const num = parseInt(match[1]);
      if(num >= 1 && num <= 1900) {
        data.findeksScore = num;
        break;
      }
    }
  }
  
  // 2. Limitler ToplamÄ± (D3)
  const limitMatch = text.match(/Limitler\s*Toplam[iÄ±]\s*\(?D3\)?\s*[:\-]?\s*([\d\.,]+)\s*TL/i);
  if(limitMatch) {
    data.totalLimit = parseFloat(limitMatch[1].replace(/\./g, '').replace(',', '.'));
  }
  
  // 3. BorÃ§lar ToplamÄ± (D4)
  const debtMatch = text.match(/Bor[cÃ§]lar\s*Toplam[iÄ±]\s*\(?D4\)?\s*[:\-]?\s*([\d\.,]+)\s*TL/i);
  if(debtMatch) {
    data.totalDebt = parseFloat(debtMatch[1].replace(/\./g, '').replace(',', '.'));
  }
  
  // 4. Kredi KartÄ± DetaylarÄ±nÄ± Ã‡Ä±kar (Yeni)
  // Ã–rnek pattern: "Kredi KartÄ± A Åube Limit: 50.000 GÃ¼ncel BorÃ§: 15.000"
  const cardPatterns = [
    /Kredi\s*Kart[Ä±i]\s*(?:[A-Z]|[0-9]+)\s*.*?:?\s*(\d{2})\s*([A-Za-zÅŸÄŸÄ±Ã¼Ã§Ã¶\s]+)\s*.*?Limit\s*[:\-]?\s*([\d\.,]+)\s*TL.*?Bor[cÃ§]\s*[:\-]?\s*([\d\.,]+)\s*TL/gi,
    /Kredi\s*Kart[Ä±i].*?Ticari/gi
  ];
  
  // Her "Kredi KartÄ±" ifadesinden sonraki bÃ¶lÃ¼mÃ¼ analiz et
  const cardSections = text.split(/Kredi\s*Kart[Ä±i]/gi);
  if(cardSections.length > 1) {
    cardSections.forEach((section, idx) => {
      if(idx === 0) return; // Ä°lk bÃ¶lÃ¼m Ã¶ncesidir
      
      const cardLimit = section.match(/Limit\s*[:\-]?\s*([\d\.,]+)\s*TL/i);
      const cardDebt = section.match(/(?:GÃ¼ncel\s*)?Bor[cÃ§]\s*[:\-]?\s*([\d\.,]+)\s*TL/i);
      const cardMinPayment = section.match(/Asgari\s*Ã–deme\s*[:\-]?\s*([\d\.,]+)\s*TL/i);
      const cardType = section.match(/(Visa|Mastercard|Amex)/i);
      const bankName = section.match(/([A-Za-zÅŸÅÄ±Ä°Ã§Ã‡Ã¶Ã–Ã¼ÃœÄŸÄ\s]+?)(?=\s*(?:Åube|Limit))/i);
      
      if(cardLimit || cardDebt) {
        data.creditCards.push({
          bank: bankName ? bankName[1].trim() : 'Bilinmeyen Banka',
          limit: cardLimit ? parseFloat(cardLimit[1].replace(/\./g, '').replace(',', '.')) : 0,
          debt: cardDebt ? parseFloat(cardDebt[1].replace(/\./g, '').replace(',', '.')) : 0,
          minPayment: cardMinPayment ? parseFloat(cardMinPayment[1].replace(/\./g, '').replace(',', '.')) : 0,
          type: cardType ? cardType[1] : 'Kredi KartÄ±',
          utilization: cardLimit ? Math.round((parseFloat(cardDebt ? cardDebt[1].replace(/\./g, '').replace(',', '.') : 0) / parseFloat(cardLimit[1].replace(/\./g, '').replace(',', '.'))) * 100) : 0
        });
      }
    });
  }
  
  // 5. KMH (Kredili Mevduat HesabÄ±) Ã‡Ä±karÄ±mÄ± (Yeni)
  const kmhPatterns = [
    /Kredili\s*Mevduat\s*Hesab[Ä±i].*?Limit\s*([\d\.,]+)\s*TL.*?Kullan[Ä±i]lan\s*([\d\.,]+)\s*TL/gsi,
    /KMH.*?Limit\s*([\d\.,]+)\s*TL.*?Bor[cÃ§]\s*([\d\.,]+)\s*TL/gsi,
    /Ek\s*Hesap.*?Limit\s*([\d\.,]+)\s*TL.*?Kullan[Ä±i]lan\s*([\d\.,]+)\s*TL/gsi
  ];
  
  kmhPatterns.forEach(pattern => {
    let match;
    while((match = pattern.exec(text)) !== null) {
      const limit = parseFloat(match[1].replace(/\./g, '').replace(',', '.'));
      const used = parseFloat(match[2].replace(/\./g, '').replace(',', '.'));
      data.kmh.push({
        type: 'Kredili Mevduat HesabÄ± (KMH)',
        limit: limit,
        used: used,
        available: limit - used,
        utilization: Math.round((used / limit) * 100)
      });
    }
  });
  
  // EÄŸer regex bulamazsa, metin iÃ§inde KMH aramasÄ± yap
  if(data.kmh.length === 0 && text.match(/Kredili\s*Mevduat|KMH|Ek\s*Hesap/i)) {
    // Basit arama: KMH sonrasÄ± limit ve kullanÄ±m bilgisi
    const kmhSection = text.match(/Kredili\s*Mevduat.*?TL\s+([\d\.,]+)\s+TL\s+([\d\.,]+)\s+TL/);
    if(kmhSection) {
      const limit = parseFloat(kmhSection[1].replace(/\./g, '').replace(',', '.'));
      const used = parseFloat(kmhSection[2].replace(/\./g, '').replace(',', '.'));
      data.kmh.push({
        type: 'Kredili Mevduat HesabÄ± (Tespit Edilen)',
        limit: limit,
        used: used,
        available: limit - used,
        utilization: Math.round((used / limit) * 100)
      });
    }
  }
  
  // 6. Limit KullanÄ±m OranÄ±
  if(data.totalLimit > 0) {
    data.utilizationRate = Math.round((data.totalDebt / data.totalLimit) * 100);
  }
  
  // 7. Gecikme ve diÄŸer bilgiler (mevcut kod devamÄ±)
  const delayMatch = text.match(/Gecikmedeki\s*Hesap\s*Say[iÄ±]s[iÄ±]\s*\(?E1\)?\s*[:\-]?\s*(\d+|-)/i);
  if(delayMatch && delayMatch[1] !== '-' && parseInt(delayMatch[1]) > 0) {
    data.delayStatus = 'delayed';
    data.delayedAccounts = parseInt(delayMatch[1]);
  }
  
  const maxDelayMatch = text.match(/En\s*B[Ã¼u]y[Ã¼u]k\s*Gecikme\s*G[Ã¼u]n\s*Say[iÄ±]s[iÄ±]\s*[:\-]?\s*(\d+|-)/i);
  if(maxDelayMatch && maxDelayMatch[1] !== '-') {
    data.maxDelayDays = parseInt(maxDelayMatch[1]);
  }
  
  return data;
}

function displayPdfDetails(data) {
  const container = el("pdfDetailReport");
  
  let delayHtml = '';
  if(data.delayStatus === 'delayed') {
    delayHtml = `<div class="pdf-alert">âš ï¸ <strong>Dikkat:</strong> Aktif gecikme bulunmaktadÄ±r (${data.delayedAccounts} hesap). En bÃ¼yÃ¼k gecikme: ${data.maxDelayDays} gÃ¼n.</div>`;
  } else {
    delayHtml = `<div class="pdf-alert" style="background:rgba(16,185,129,0.1);border-color:rgba(16,185,129,0.3);color:#a7f3d0;">âœ… Ã–deme performansÄ± temiz. Aktif gecikme bulunmamaktadÄ±r.</div>`;
  }
  
  // Limit kullanÄ±m oranÄ± renklendirme
  const utilColor = data.utilizationRate > 90 ? '#ef4444' : data.utilizationRate > 70 ? '#f59e0b' : '#10b981';
  const utilBg = data.utilizationRate > 90 ? 'linear-gradient(90deg, #ef4444, #dc2626)' : 
                 data.utilizationRate > 70 ? 'linear-gradient(90deg, #f59e0b, #d97706)' : 
                 'linear-gradient(90deg, #10b981, #059669)';
  
  // Kredi KartlarÄ± HTML'i
  let cardsHtml = '';
  if(data.creditCards && data.creditCards.length > 0) {
    cardsHtml = `
      <div class="pdf-detail-card">
        <h4>ğŸ’³ Kredi KartlarÄ± DetayÄ± (${data.creditCards.length} Adet)</h4>
        <table class="card-details-table">
          <thead>
            <tr>
              <th>Banka</th>
              <th>Limit</th>
              <th>GÃ¼ncel BorÃ§</th>
              <th>Kull. %</th>
              <th>Asgari Ã–deme</th>
            </tr>
          </thead>
          <tbody>
            ${data.creditCards.map(card => `
              <tr>
                <td><strong>${card.bank}</strong> ${card.type ? '(' + card.type + ')' : ''}</td>
                <td>${card.limit.toLocaleString()} TL</td>
                <td>${card.debt.toLocaleString()} TL</td>
                <td>
                  <div style="display:flex;align-items:center;gap:8px;">
                    <div style="flex:1; background:rgba(0,0,0,0.3); border-radius:4px; height:8px; overflow:hidden;">
                      <div style="width:${card.utilization}%; height:100%; background:${card.utilization > 90 ? '#ef4444' : card.utilization > 70 ? '#f59e0b' : '#10b981'};"></div>
                    </div>
                    <span style="font-size:11px; min-width:35px;">%${card.utilization}</span>
                  </div>
                </td>
                <td>${card.minPayment > 0 ? card.minPayment.toLocaleString() + ' TL' : '-'}</td>
              </tr>
            `).join('')}
          </tbody>
          <tfoot style="background:rgba(0,0,0,0.2); font-weight:600;">
            <tr>
              <td>TOPLAM</td>
              <td>${data.creditCards.reduce((sum, c) => sum + c.limit, 0).toLocaleString()} TL</td>
              <td>${data.creditCards.reduce((sum, c) => sum + c.debt, 0).toLocaleString()} TL</td>
              <td colspan="2"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    `;
  }
  
  // KMH HTML'i
  let kmhHtml = '';
  if(data.kmh && data.kmh.length > 0) {
    kmhHtml = `
      <div class="pdf-detail-card">
        <h4>ğŸ¦ Kredili Mevduat HesabÄ± (KMH) DetayÄ±</h4>
        ${data.kmh.map(k => `
          <div class="kmh-card">
            <div class="pdf-detail-grid">
              <div class="pdf-detail-item">
                <span class="pdf-detail-label">Hesap TÃ¼rÃ¼</span>
                <span class="pdf-detail-value" style="color:var(--info);">${k.type}</span>
              </div>
              <div class="pdf-detail-item">
                <span class="pdf-detail-label">Toplam Limit</span>
                <span class="pdf-detail-value">${k.limit.toLocaleString()} TL</span>
              </div>
              <div class="pdf-detail-item ${k.utilization > 80 ? 'warning' : 'success'}">
                <span class="pdf-detail-label">KullanÄ±lan</span>
                <span class="pdf-detail-value">${k.used.toLocaleString()} TL</span>
              </div>
              <div class="pdf-detail-item success">
                <span class="pdf-detail-label">KullanÄ±labilir</span>
                <span class="pdf-detail-value">${k.available.toLocaleString()} TL</span>
              </div>
            </div>
            <div style="margin-top:12px;">
              <div style="display:flex;justify-content:space-between; font-size:12px; margin-bottom:4px;">
                <span style="color:var(--muted);">KMH KullanÄ±m OranÄ±</span>
                <span style="font-weight:700; color:${k.utilization > 80 ? '#f59e0b' : '#10b981'};">%${k.utilization}</span>
              </div>
              <div class="progress-bar-bg">
                <div class="progress-bar-fill" style="width:${Math.min(k.utilization, 100)}%; background:${k.utilization > 80 ? 'linear-gradient(90deg, #f59e0b, #d97706)' : 'linear-gradient(90deg, #10b981, #059669)'};">
                </div>
              </div>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  }
  
  container.innerHTML = `
    <div class="pdf-detail-card">
      <h4>ğŸ“Š Findeks Kredi Notu ve Ã–zet</h4>
      <div class="pdf-detail-grid">
        <div class="pdf-detail-item">
          <span class="pdf-detail-label">Findeks Skoru</span>
          <span class="pdf-detail-value" style="color:${data.findeksScore >= 1400 ? '#10b981' : data.findeksScore >= 1000 ? '#f59e0b' : '#ef4444'}; font-size:24px;">${data.findeksScore}</span>
        </div>
        <div class="pdf-detail-item">
          <span class="pdf-detail-label">Risk Grubu</span>
          <span class="pdf-detail-value">${getRiskGroup(data.findeksScore)}</span>
        </div>
        <div class="pdf-detail-item">
          <span class="pdf-detail-label">Toplam Limit</span>
          <span class="pdf-detail-value">${data.totalLimit.toLocaleString()} TL</span>
        </div>
        <div class="pdf-detail-item ${data.totalDebt > 100000 ? 'warning' : ''}">
          <span class="pdf-detail-label">Toplam BorÃ§</span>
          <span class="pdf-detail-value">${data.totalDebt.toLocaleString()} TL</span>
        </div>
      </div>
      
      <div style="margin-top:16px; background:rgba(0,0,0,0.2); padding:16px; border-radius:8px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <span style="font-size:13px; color:var(--muted);">Genel Limit KullanÄ±m OranÄ±</span>
          <span style="font-weight:800; color:${utilColor}; font-size:18px;">%${data.utilizationRate}</span>
        </div>
        <div class="progress-bar-bg" style="height:32px;">
          <div class="progress-bar-fill" style="width:${Math.min(data.utilizationRate, 100)}%; background:${utilBg}; font-size:14px;">
            ${data.utilizationRate > 15 ? '%' + data.utilizationRate : ''}
          </div>
        </div>
        <div style="margin-top:8px; font-size:12px; color:var(--muted);">
          ${data.utilizationRate > 90 ? 'âš ï¸ Limit kullanÄ±m oranÄ± Ã§ok yÃ¼ksek! Kredi baÅŸvurusu olumsuz etkilenebilir.' : 
            data.utilizationRate > 70 ? 'âš ï¸ YÃ¼ksek limit kullanÄ±mÄ± mevcut.' : 
            'âœ… Limit kullanÄ±m oranÄ± saÄŸlÄ±klÄ± seviyede.'}
        </div>
      </div>
      
      ${delayHtml}
    </div>
    
    ${cardsHtml}
    
    ${kmhHtml}
    
    <div style="text-align:center;margin:16px 0;">
      <button class="btn btn-primary" onclick="usePdfDataForEvaluation()">
        ğŸ“‹ Bu Verileri DeÄŸerlendirme Formuna Aktar
      </button>
    </div>
  `;
}

function getRiskGroup(score) {
  if(score >= 1700) return "A (MÃ¼kemmel)";
  if(score >= 1400) return "B (Ä°yi)";
  if(score >= 1200) return "C (Orta)";
  if(score >= 1000) return "D (Riskli)";
  return "E (Ã‡ok Riskli)";
}

function fillEvaluationForm(data) {
  // Findeks skoru
  if(data.findeksScore) {
    el("findeks").value = data.findeksScore;
    updateFindexPreview();
  }
  
  // Kredi sayÄ±sÄ± (Kartlar + KMH + diÄŸer krediler)
  const totalProducts = (data.creditCards?.length || 0) + (data.kmh?.length || 0);
  if(totalProducts > 0) {
    el("loanCount").value = totalProducts;
  }
  
  // Mevcut taksit hesaplama
  if(data.totalDebt > 0) {
    const estimatedMonthly = Math.round(data.totalDebt / 36);
    el("currentInst").value = estimatedMonthly;
  }
  
  // Gecikme durumu
  if(data.maxDelayDays > 0 && data.maxDelayDays <= 30) {
    el("delay").value = "1";
  } else if(data.maxDelayDays > 30) {
    el("delay").value = "3";
  } else {
    el("delay").value = "0";
  }
  
  // Bilgilendirme mesajÄ±
  el("autoFillInfo").style.display = "block";
  el("autoFillInfo").innerHTML = `
    <strong>âœ… PDF'den Otomatik Doldurulan Bilgiler:</strong><br>
    â€¢ Findeks Skoru: <b>${data.findeksScore}</b><br>
    â€¢ Kredi KartÄ±: <b>${data.creditCards?.length || 0} adet</b><br>
    â€¢ KMH: <b>${data.kmh?.length || 0} adet</b><br>
    â€¢ Toplam BorÃ§: <b>${data.totalDebt?.toLocaleString()} TL</b><br>
    â€¢ Limit KullanÄ±m: <b>%${data.utilizationRate}</b><br>
    <small style="opacity:0.8;">* Gelir bilgisini manuel girmeyi unutmayÄ±n!</small>
  `;
}

function usePdfDataForEvaluation() {
  if(lastPdfData) {
    fillEvaluationForm(lastPdfData);
    switchTab('evaluate', document.querySelectorAll('.tab-btn')[0]);
    showSuccess("PDF verileri DeÄŸerlendirme formuna aktarÄ±ldÄ±. LÃ¼tfen gelir bilgisini girerek analizi tamamlayÄ±n.");
  }
}

function analyzeFindexDetail() {
  const score = parseInt(el("analyzeFindex").value);
  if(!score || score < 0 || score > 1900) {
    alert("GeÃ§erli findeks girin (0-1900 arasÄ±)");
    return;
  }
  
  let html = `<div class="findex-analysis" style="display:block;">`;
  
  let group, color, banks, advice;
  if(score >= 1700) {
    group = "A (MÃ¼kemmel)";
    color = "#10b981";
    banks = "TÃ¼m bankalar (Akbank, Garanti dahil)";
    advice = "En yÃ¼ksek limitler, en dÃ¼ÅŸÃ¼k faizler. 6-8 maaÅŸ limit Ã§arpanÄ±.";
  } else if(score >= 1400) {
    group = "B (Ä°yi)";
    color = "#3b82f6";
    banks = "TÃ¼m bankalar";
    advice = "Standart onay. 5-6 maaÅŸ limit. Akbank dÄ±ÅŸÄ±nda her yerde rahat onay.";
  } else if(score >= 1200) {
    group = "C (Orta)";
    color = "#f59e0b";
    banks = "Halkbank, Ziraat, VakÄ±fbank, Ä°ÅŸ BankasÄ±";
    advice = "GM ile onay. 4-5 maaÅŸ limit. Dijital bankalarda (Garanti, Akbank) zorlanabilirsiniz.";
  } else if(score >= 1000) {
    group = "D (Riskli)";
    color = "#ef4444";
    banks = "Sadece Halkbank, Ziraat (Kamu bankalarÄ±)";
    advice = "Temek ihtiyaÃ§ kredisi. 3-4 maaÅŸ limit. Kefil/teminat gerekli olabilir.";
  } else {
    group = "E (Ã‡ok Riskli)";
    color = "#7c2d12";
    banks = "Kredi almanÄ±z Ã§ok zor";
    advice = "Ã–nce findeksinizi iyileÅŸtirin. 6-12 ay dÃ¼zgÃ¼n Ã¶deme yapÄ±n.";
  }
  
  html += `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <div>
        <div style="font-size:24px;font-weight:800;color:${color}">${score}</div>
        <div style="font-size:14px;color:var(--muted);">Risk Grubu: ${group}</div>
      </div>
      <div style="text-align:right;">
        <div style="font-size:12px;color:var(--muted);">BaÅŸvuru YapabileceÄŸiniz Bankalar</div>
        <div style="font-size:14px;font-weight:600;margin-top:4px;">${banks}</div>
      </div>
    </div>
    
    <div class="findex-bar" style="margin-bottom:16px;">
      <div class="findex-fill" style="width:${(score/1900*100)}%;background:${color};"></div>
    </div>
    
    <div style="background:rgba(0,0,0,0.2);padding:16px;border-radius:8px;margin-bottom:16px;">
      <div style="font-weight:700;margin-bottom:8px;">ğŸ’¡ BankacÄ± Tavsiyesi</div>
      <div style="font-size:13px;line-height:1.6;">${advice}</div>
    </div>
    
    <h4 style="margin:16px 0 12px 0;">Banka BazlÄ± DeÄŸerlendirme</h4>
    <table style="margin-top:0;">
      <thead>
        <tr>
          <th>Banka</th>
          <th>Durum</th>
          <th>Tahmini Limit</th>
          <th>Not</th>
        </tr>
      </thead>
      <tbody>
        ${Object.entries(BANKS).map(([key,bank]) => {
          let status, limitMult, note;
          if(score >= bank.minFindeks + 200) {
            status = "âœ… Onay";
            limitMult = bank.multipliers.limit;
          } else if(score >= bank.minFindeks) {
            status = "âš ï¸ GM";
            limitMult = bank.multipliers.limit * 0.7;
          } else {
            status = "âŒ Red";
            limitMult = 0;
          }
          return `
            <tr>
              <td><strong style="color:${bank.color}">${bank.name}</strong></td>
              <td>${status}</td>
              <td>${limitMult > 0 ? (limitMult + ' maaÅŸ') : '-'}</td>
              <td style="font-size:12px;">${bank.features[0]}</td>
            </tr>
          `;
        }).join('')}
      </tbody>
    </table>
  </div>`;
  
  el("findexDetailResult").innerHTML = html;
}

document.addEventListener('keypress', function(e) {
  if(e.key === 'Enter') {
    if(el("loginScreen").style.display !== "none") doLogin();
  }
});
</script>
</body>
</html>
